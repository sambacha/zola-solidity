<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Custom Ethereum RPC Methods</title>
  <link rel="stylesheet" href="/style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="A specification for managing changes to custom EVM RPC Methods">
  <meta charset="UTF-8">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Custom Ethereum RPC Methods">
  <meta property="og:description" content="A specification for managing changes to custom EVM RPC Methods">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@foldfinance">
  
</head>

<body>
  <article>
    <h1>Solidity Documentation</h1>
    <p class="status">
      Version 0.0.2<br/>
      (Last updated on May  9, 2022)<br/>
      See the <a href="https://github.com/sambacha/custom-evm-rpc">source</a>,
      file an <a href="https://github.com/sambacha/custom-evm-rpc/issues">issue</a>,
      or suggest a <a href="https://github.com/sambacha/custom-evm-rpc/pulls">change</a>.
    </p>
    <hr/>

    <h2 id="v1-architecture-design-and-threat-modeling">V1: Architecture, design and threat modeling</h2>
<h2 id="control-objective">Control Objective</h2>
<p>Architecture, design and threat modeling in the context of creating secure smart contracts.
Consider all possible threats before the implementation of the smart contract.</p>
<p>Ensure that a verified contract satisfies the following high-level requirements:</p>
<ul>
<li>All related smart contracts are identified and used properly,</li>
<li>Specific smart contracts security assumptions are considered during the design phase.</li>
</ul>
<p>Category “V1” lists requirements related to the architecture, design and threat modeling of the smart contracts.</p>
<h2 id="security-verification-requirements">Security Verification Requirements</h2>
<table><thead><tr><th>#</th><th>Description</th></tr></thead><tbody>
<tr><td><strong>1.1</strong></td><td>Verify that the every introduced design change is preceded by an earlier threat modeling.</td></tr>
<tr><td><strong>1.2</strong></td><td>Verify that the documentation clearly and precisely defines all trust boundaries in the contract (trusted relations with other contracts and significant data flows).</td></tr>
<tr><td><strong>1.3</strong></td><td>Verify that the SCSVS, security requirements or policy is available to all developers and testers.</td></tr>
<tr><td><strong>1.4</strong></td><td>Verify that there exists an upgrade process for the contract which allows to deploy the security fixes or it is clearly stated that the contract is not upgradeable.</td></tr>
<tr><td><strong>1.5</strong></td><td>Verify that the events for the (state changing/crucial for business) operations are defined</td></tr>
<tr><td><strong>1.6</strong></td><td>Verify that there is a component that monitors the contract activity using events.</td></tr>
<tr><td><strong>1.7</strong></td><td>Verify that there exists a mechanism that can temporarily stop the sensitive functionalities of the contract in case of a new attack. This mechanism should not block access to the assets (e.g. tokens) for the owners.</td></tr>
<tr><td><strong>1.8</strong></td><td>Verify that there is a policy to track new security bugs and to update the libraries to the latest secure version.</td></tr>
<tr><td><strong>1.9</strong></td><td>Verify that the value of cryptocurrencies kept on contract is controlled and at the minimal acceptable level.</td></tr>
<tr><td><strong>1.10</strong></td><td>Verify that if the fallback function can be called by anyone it is included in the threat modelling.</td></tr>
<tr><td><strong>1.11</strong></td><td>Verify that the business logic in contracts is consistent. Important changes in the logic should be allowed for all or none of the contracts.</td></tr>
<tr><td><strong>1.12</strong></td><td>Verify that code analysis tools are in use that can detect potentially malicious code.</td></tr>
<tr><td><strong>1.13</strong></td><td>Verify that the latest version of the major Solidity release is used.</td></tr>
<tr><td><strong>1.14</strong></td><td>Verify that, when using the external implementation of contract, you use the current version which has not been superseded.</td></tr>
<tr><td><strong>1.15</strong></td><td>Verify that there are no vulnerabilities associated with system architecture and design.</td></tr>
</tbody></table>
<h2 id="contract">Contract</h2>
<pre data-lang="solidity" class="language-solidity z-code"><code class="language-solidity" data-lang="solidity"><span class="z-source z-solidity">

<span class="z-keyword z-sol">pragma</span> <span class="z-keyword z-sol">solidity</span> <span class="z-keyword z-sol">^</span><span class="z-constant z-numeric z-integer z-sol">0</span><span class="z-constant z-numeric z-integer z-sol">.6.12</span>;
<span class="z-keyword z-other z-sol">pragma</span> <span class="z-keyword z-other z-sol">experimental</span> ABIEncoderV2;


<span class="z-keyword z-declaration z-class">contract</span> <span class="z-support z-function">MultiCall</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
    
    <span class="z-keyword z-declaration z-struct">struct</span> <span class="z-support z-function">Call</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        <span class="z-constant z-language">address</span> to;
        <span class="z-constant z-language">bytes</span> data;
    <span class="z-punctuation z-section z-block z-end">}</span>
    
   <span class="z-keyword z-declaration z-function">function</span> <span class="z-entity z-name z-function">multicall</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-scope">Call</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">calls</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-storage z-modifier">public</span> <span class="z-keyword">returns</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">bytes</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">results</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        results <span class="z-keyword z-operator z-assignment">=</span> <span class="z-keyword">new</span> <span class="z-constant z-language">bytes</span><span class="z-punctuation z-definition z-start z-sol">[</span><span class="z-punctuation z-definition z-end z-sol">]</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span>calls.<span class="z-storage z-type">length</span><span class="z-punctuation z-definition z-end z-sol">)</span>;
        <span class="z-keyword">for</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">uint</span> i <span class="z-keyword z-operator z-assignment">=</span> <span class="z-constant z-numeric">0</span>; i <span class="z-keyword z-operator z-logical">&lt;</span> calls.<span class="z-storage z-type">length</span>; i<span class="z-keyword z-operator z-arithmetic">+</span><span class="z-keyword z-operator z-arithmetic">+</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
            <span class="z-punctuation z-definition z-start z-sol">(</span>, results<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span><span class="z-punctuation z-definition z-end z-sol">)</span> <span class="z-keyword z-operator z-assignment">=</span> calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.to.<span class="z-storage z-type">call</span>(calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.data<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
        <span class="z-punctuation z-section z-block z-end">}</span>
    <span class="z-punctuation z-section z-block z-end">}</span>
    
    
    <span class="z-comment z-line z-double-slash"><span class="z-punctuation z-definition z-comment">//</span> be careful with calls.length == 0
</span>    <span class="z-keyword z-declaration z-function">function</span> <span class="z-entity z-name z-function">multicallWithGasLimitation</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-scope">Call</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">calls</span>, <span class="z-constant z-language">uint256</span> <span class="z-variable z-parameter">gasBuffer</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-storage z-modifier">public</span> <span class="z-keyword">returns</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">bytes</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">results</span>, <span class="z-constant z-language">uint256</span> <span class="z-variable z-parameter">lastSuccessIndex</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        results <span class="z-keyword z-operator z-assignment">=</span> <span class="z-keyword">new</span> <span class="z-constant z-language">bytes</span><span class="z-punctuation z-definition z-start z-sol">[</span><span class="z-punctuation z-definition z-end z-sol">]</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span>calls.<span class="z-storage z-type">length</span><span class="z-punctuation z-definition z-end z-sol">)</span>;
        <span class="z-keyword">for</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">uint</span> i <span class="z-keyword z-operator z-assignment">=</span> <span class="z-constant z-numeric">0</span>; i <span class="z-keyword z-operator z-logical">&lt;</span> calls.<span class="z-storage z-type">length</span>; i<span class="z-keyword z-operator z-arithmetic">+</span><span class="z-keyword z-operator z-arithmetic">+</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
            <span class="z-punctuation z-definition z-start z-sol">(</span>, results<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span><span class="z-punctuation z-definition z-end z-sol">)</span> <span class="z-keyword z-operator z-assignment">=</span> calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.to.<span class="z-storage z-type">call</span>(calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.data<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
            <span class="z-keyword">if</span> <span class="z-punctuation z-definition z-start z-sol">(</span><span class="z-storage z-type">gasleft</span>(<span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-keyword z-operator z-logical">&lt;</span> gasBuffer<span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
                <span class="z-keyword">return</span> <span class="z-punctuation z-definition z-start z-sol">(</span>results, i<span class="z-punctuation z-definition z-end z-sol">)</span>;
            <span class="z-punctuation z-section z-block z-end">}</span>
        <span class="z-punctuation z-section z-block z-end">}</span>
        <span class="z-keyword">return</span> <span class="z-punctuation z-definition z-start z-sol">(</span>results, calls.<span class="z-storage z-type">length</span> <span class="z-keyword z-operator z-arithmetic">-</span> <span class="z-constant z-numeric">1</span><span class="z-punctuation z-definition z-end z-sol">)</span>;
    <span class="z-punctuation z-section z-block z-end">}</span>
    
   <span class="z-keyword z-declaration z-function">function</span> <span class="z-entity z-name z-function">multicallWithGas</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-scope">Call</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">calls</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-storage z-modifier">public</span> <span class="z-keyword">returns</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">bytes</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">results</span>, <span class="z-constant z-language">uint256</span>[] <span class="z-storage z-modifier">memory</span> <span class="z-variable z-parameter">gasUsed</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        results <span class="z-keyword z-operator z-assignment">=</span> <span class="z-keyword">new</span> <span class="z-constant z-language">bytes</span><span class="z-punctuation z-definition z-start z-sol">[</span><span class="z-punctuation z-definition z-end z-sol">]</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span>calls.<span class="z-storage z-type">length</span><span class="z-punctuation z-definition z-end z-sol">)</span>;
        gasUsed <span class="z-keyword z-operator z-assignment">=</span> <span class="z-keyword">new</span> <span class="z-constant z-language">uint256</span><span class="z-punctuation z-definition z-start z-sol">[</span><span class="z-punctuation z-definition z-end z-sol">]</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span>calls.<span class="z-storage z-type">length</span><span class="z-punctuation z-definition z-end z-sol">)</span>;
        <span class="z-keyword">for</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">uint</span> i <span class="z-keyword z-operator z-assignment">=</span> <span class="z-constant z-numeric">0</span>; i <span class="z-keyword z-operator z-logical">&lt;</span> calls.<span class="z-storage z-type">length</span>; i<span class="z-keyword z-operator z-arithmetic">+</span><span class="z-keyword z-operator z-arithmetic">+</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
            <span class="z-constant z-language">uint256</span> initialGas <span class="z-keyword z-operator z-assignment">=</span> <span class="z-storage z-type">gasleft</span>(<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
            <span class="z-punctuation z-definition z-start z-sol">(</span>, results<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span><span class="z-punctuation z-definition z-end z-sol">)</span> <span class="z-keyword z-operator z-assignment">=</span> calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.to.<span class="z-storage z-type">call</span>(calls<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span>.data<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
            gasUsed<span class="z-punctuation z-section z-block z-begin z-expr">[</span>i<span class="z-punctuation z-section z-block z-end z-expr">]</span> <span class="z-keyword z-operator z-assignment">=</span> initialGas <span class="z-keyword z-operator z-arithmetic">-</span> <span class="z-storage z-type">gasleft</span>(<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
        <span class="z-punctuation z-section z-block z-end">}</span>
    <span class="z-punctuation z-section z-block z-end">}</span>
    
    <span class="z-keyword z-declaration z-function">function</span> <span class="z-entity z-name z-function">gaslimit</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-storage z-modifier">external</span> <span class="z-storage z-modifier">view</span> <span class="z-keyword">returns</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">uint256</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        <span class="z-keyword">return</span> <span class="z-storage z-type">block</span>.<span class="z-storage z-type">gaslimit</span>;
    <span class="z-punctuation z-section z-block z-end">}</span>
    
    <span class="z-keyword z-declaration z-function">function</span> <span class="z-entity z-name z-function">gasLeft</span><span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-storage z-modifier">external</span> <span class="z-storage z-modifier">view</span> <span class="z-keyword">returns</span> <span class="z-punctuation z-section z-block z-begin z-sol">(</span><span class="z-constant z-language">uint256</span><span class="z-punctuation z-section z-block z-end z-sol">)</span> <span class="z-punctuation z-section z-block z-begin z-sol">{</span>
        <span class="z-keyword">return</span> <span class="z-storage z-type">gasleft</span>(<span class="z-punctuation z-section z-block z-end z-sol">)</span>;
    <span class="z-punctuation z-section z-block z-end">}</span>
<span class="z-punctuation z-section z-block z-end">}</span>
</span></code></pre>
<h2 id="provider">Provider</h2>
<pre data-lang="typescript" class="language-typescript z-code"><code class="language-typescript" data-lang="typescript"><span class="z-source z-ts"><span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">Provider</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>@ethersproject/providers<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">HardhatRuntimeEnvironment</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>hardhat/types<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">URL</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>url<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-comment z-block z-documentation z-ts"><span class="z-punctuation z-definition z-comment z-ts">/**</span>
 * Return either an HTTP Provider or a WebSocket provider
 * depending on the network URL given to Hardhat.
 <span class="z-punctuation z-definition z-comment z-ts">*/</span></span>
<span class="z-meta z-function z-ts"><span class="z-keyword z-control z-export z-ts">export</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">getProvider</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-variable z-parameter z-ts">hre</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">HardhatRuntimeEnvironment</span></span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span><span class="z-meta z-return z-type z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">Provider</span> </span><span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
<span class="z-punctuation z-whitespace z-comment z-leading z-ts">  </span><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> @ts-ignore</span>
  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">url</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-ts">URL</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-object z-ts">hre</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">network</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">config</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-property z-ts">url</span><span class="z-meta z-brace z-round z-ts">)</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-switch-statement z-expr z-ts"><span class="z-switch-expression z-expr z-ts"><span class="z-keyword z-control z-switch z-ts">switch</span> <span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-object z-ts">url</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-variable z-property z-dom z-ts">protocol</span><span class="z-meta z-brace z-round z-ts">)</span></span> <span class="z-switch-block z-expr z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-case-clause z-expr z-ts"><span class="z-keyword z-control z-switch z-ts">case</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>http:<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-case-clause z-expr z-ts"><span class="z-punctuation z-definition z-section z-case-statement z-ts">:</span></span>
    <span class="z-case-clause z-expr z-ts"><span class="z-keyword z-control z-switch z-ts">case</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>https:<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-case-clause z-expr z-ts"><span class="z-punctuation z-definition z-section z-case-statement z-ts">:</span></span>
      <span class="z-keyword z-control z-flow z-ts">return</span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-module z-ts">hre</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">ethers</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">providers</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-ts">JsonRpcProvider</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-object z-ts">url</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-variable z-property z-dom z-ts">href</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-case-clause z-expr z-ts"><span class="z-keyword z-control z-switch z-ts">case</span> <span class="z-string z-quoted z-double z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&quot;</span>wss:<span class="z-punctuation z-definition z-string z-end z-ts">&quot;</span></span></span><span class="z-case-clause z-expr z-ts"><span class="z-punctuation z-definition z-section z-case-statement z-ts">:</span></span>
      <span class="z-keyword z-control z-flow z-ts">return</span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-module z-ts">hre</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">ethers</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">providers</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-ts">WebSocketProvider</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-object z-ts">url</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-variable z-property z-dom z-ts">href</span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-case-clause z-expr z-ts"><span class="z-keyword z-control z-switch z-ts">default</span></span><span class="z-case-clause z-expr z-ts"><span class="z-punctuation z-definition z-section z-case-statement z-ts">:</span></span>
      <span class="z-keyword z-control z-trycatch z-ts">throw</span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-ts">Error</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-template z-ts"><span class="z-punctuation z-definition z-string z-template z-begin z-ts">`</span>Network URL not valid: &#39;<span class="z-meta z-template z-expression z-ts"><span class="z-punctuation z-definition z-template-expression z-begin z-ts">${</span></span><span class="z-meta z-template z-expression z-ts"><span class="z-meta z-embedded z-line z-ts"><span class="z-variable z-other z-object z-ts">url</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-variable z-property z-dom z-ts">href</span></span><span class="z-punctuation z-definition z-template-expression z-end z-ts">}</span></span>&#39;<span class="z-punctuation z-definition z-string z-template z-end z-ts">`</span></span><span class="z-meta z-brace z-round z-ts">)</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  </span><span class="z-punctuation z-definition z-block z-ts">}</span></span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span>


<span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">HardhatRuntimeEnvironment</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>hardhat/types<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-meta z-import z-ts"><span class="z-keyword z-control z-import z-ts">import</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span> <span class="z-variable z-other z-readwrite z-alias z-ts">WebSocketProvider</span> <span class="z-punctuation z-definition z-block z-ts">}</span></span> <span class="z-keyword z-control z-from z-ts">from</span> <span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>@ethersproject/providers<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

<span class="z-comment z-block z-documentation z-ts"><span class="z-punctuation z-definition z-comment z-ts">/**</span>
 * Start a keep-alive WebSocket connection in Hardhat.
 * 
 * The function will periodically check whether the connection is still
 * open, and restart it if it is not.
 *
 * Usage:
 *
 *   startConnection(hre, async (hre, provider) =&gt; {
 *       // Your code here
 *   }
 *
 * Source: https://github.com/ethers-io/ethers.js/issues/1053#issuecomment-808736570
 <span class="z-punctuation z-definition z-comment z-ts">*/</span></span>
<span class="z-meta z-function z-ts"><span class="z-keyword z-control z-export z-ts">export</span> <span class="z-storage z-type z-function z-ts">function</span> <span class="z-meta z-definition z-function z-ts"><span class="z-entity z-name z-function z-ts">startConnection</span></span><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span>
  <span class="z-variable z-parameter z-ts">hre</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">HardhatRuntimeEnvironment</span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-entity z-name z-function z-ts">onOpen</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-meta z-type z-function z-ts"><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-variable z-parameter z-ts">hre</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">HardhatRuntimeEnvironment</span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span> <span class="z-variable z-parameter z-ts">p</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">WebSocketProvider</span></span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span></span> <span class="z-meta z-type z-function z-return z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-support z-type z-primitive z-ts">void</span></span></span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">expectedPongBack</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">number</span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-constant z-numeric z-decimal z-ts">15000</span><span class="z-punctuation z-separator z-parameter z-ts">,</span>
  <span class="z-variable z-parameter z-ts">keepAliveCheckInterval</span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">number</span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-constant z-numeric z-decimal z-ts">7500</span>
<span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span><span class="z-meta z-return z-type z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-support z-type z-primitive z-ts">void</span> </span><span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">logger</span></span> </span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-new z-expr z-ts"><span class="z-keyword z-operator z-new z-ts">new</span> <span class="z-entity z-name z-type z-module z-ts">hre</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">ethers</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-module z-ts">utils</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-ts">Logger</span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>v1.0<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-meta z-brace z-round z-ts">)</span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">const</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-constant z-ts">provider</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-ts">WebSocketProvider</span> </span></span><span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">getProvider</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">hre</span><span class="z-meta z-brace z-round z-ts">)</span> <span class="z-keyword z-control z-as z-ts">as</span> <span class="z-entity z-name z-type z-ts">WebSocketProvider</span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">let</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-readwrite z-ts">pingTimeout</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-module z-ts">NodeJS</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-ts">Timeout</span></span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-meta z-var z-expr z-ts"><span class="z-storage z-type z-ts">let</span> <span class="z-meta z-var-single-variable z-expr z-ts"><span class="z-meta z-definition z-variable z-ts"><span class="z-variable z-other z-readwrite z-ts">keepAliveInterval</span></span><span class="z-meta z-type z-annotation z-ts"><span class="z-keyword z-operator z-type z-annotation z-ts">:</span> <span class="z-entity z-name z-type z-module z-ts">NodeJS</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-type z-ts">Timeout</span></span></span></span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

  <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">provider</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">_websocket</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">on</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>open<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span><span class="z-meta z-arrow z-ts"> <span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-variable z-other z-readwrite z-ts">keepAliveInterval</span> <span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-support z-function z-ts">setInterval</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-arrow z-ts"><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
      <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">logger</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">debug</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>&gt; Checking if the connection is alive, sending a ping<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
      <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">provider</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">_websocket</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">ping</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-whitespace z-comment z-leading z-ts">      </span><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> Delay should be equal to the interval at which your server</span>
<span class="z-punctuation z-whitespace z-comment z-leading z-ts">      </span><span class="z-comment z-line z-double-slash z-ts"><span class="z-punctuation z-definition z-comment z-ts">//</span></span><span class="z-comment z-line z-double-slash z-ts"> sends out pings plus a conservative assumption of the latency.</span>
      <span class="z-variable z-other z-readwrite z-ts">pingTimeout</span> <span class="z-keyword z-operator z-assignment z-ts">=</span> <span class="z-meta z-function-call z-ts"><span class="z-support z-function z-ts">setTimeout</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-arrow z-ts"><span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
        <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">provider</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">_websocket</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-support z-function z-dom z-ts">terminate</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
      <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-variable z-other z-readwrite z-ts">expectedPongBack</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-variable z-other z-readwrite z-ts">keepAliveCheckInterval</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

    <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">onOpen</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">hre</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-variable z-other z-readwrite z-ts">provider</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

  <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">provider</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">_websocket</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">on</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>close<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span><span class="z-meta z-arrow z-ts"> <span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">logger</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">warn</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>&gt; WARNING: The websocket connection was closed<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-meta z-function-call z-ts"><span class="z-support z-function z-ts">clearInterval</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">keepAliveInterval</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-meta z-function-call z-ts"><span class="z-support z-function z-ts">clearTimeout</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">pingTimeout</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-meta z-function-call z-ts"><span class="z-entity z-name z-function z-ts">startConnection</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">hre</span><span class="z-punctuation z-separator z-comma z-ts">,</span> <span class="z-variable z-other z-readwrite z-ts">onOpen</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>

  <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">provider</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-variable z-other z-object z-property z-ts">_websocket</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">on</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>pong<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-punctuation z-separator z-comma z-ts">,</span><span class="z-meta z-arrow z-ts"> <span class="z-meta z-parameters z-ts"><span class="z-punctuation z-definition z-parameters z-begin z-ts">(</span><span class="z-punctuation z-definition z-parameters z-end z-ts">)</span></span> </span><span class="z-meta z-arrow z-ts"><span class="z-storage z-type z-function z-arrow z-ts">=&gt;</span> <span class="z-meta z-block z-ts"><span class="z-punctuation z-definition z-block z-ts">{</span>
    <span class="z-meta z-function-call z-ts"><span class="z-variable z-other z-object z-ts">logger</span><span class="z-punctuation z-accessor z-ts">.</span><span class="z-entity z-name z-function z-ts">debug</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-string z-quoted z-single z-ts"><span class="z-punctuation z-definition z-string z-begin z-ts">&#39;</span>&gt; Received pong, so connection is alive, clearing the timeout<span class="z-punctuation z-definition z-string z-end z-ts">&#39;</span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
    <span class="z-meta z-function-call z-ts"><span class="z-support z-function z-ts">clearInterval</span></span><span class="z-meta z-brace z-round z-ts">(</span><span class="z-variable z-other z-readwrite z-ts">pingTimeout</span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
  <span class="z-punctuation z-definition z-block z-ts">}</span></span></span><span class="z-meta z-brace z-round z-ts">)</span><span class="z-punctuation z-terminator z-statement z-ts">;</span>
<span class="z-punctuation z-definition z-block z-ts">}</span></span></span>
</span></code></pre>


    <hr/>

    <p class='hosting'><a
href=""><img
src="https://www.datocms-assets.com/31049/1618983297-powered-by-vercel.svg" /></a></p>
    </p>
  </article>
</body>

</html>